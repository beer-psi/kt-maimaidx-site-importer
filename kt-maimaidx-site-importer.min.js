"use strict";console.log("KTIMPORT");const e="prod",t={staging:{baseUrl:"https://staging.kamaitachi.xyz",clientId:"CI5ba595889dca0ebf15f700291084bbf26d199ee4"},prod:{baseUrl:"https://kamaitachi.xyz",clientId:"CIaf985c87034413cd78328c9cad474ed032822125"}},r=t[e].baseUrl,n=t[e].clientId,o="__ktimport__api-key",i=["BASIC","ADVANCED","EXPERT","MASTER","Re:MASTER"];function c(){return localStorage.getItem(`${o}_${e}`)}function a(){window.open(`${r}/client-file-flow/${n}`);document.querySelector("header").insertAdjacentHTML("afterend",'\n\t<div id="api-key-setup" style="background-color: #fff">\n\t  <form id="api-key-form">\n\t\t<input type="text" id="api-key-form-key" placeholder="Copy API Key here"/>\n\t\t<input type="submit" value="Save"/>\n\t  </form>\n\t</div>\n  '),document.querySelector("#api-key-setup").addEventListener("submit",l)}function l(t){t.preventDefault();const r=document.querySelector("#api-key-form-key").value;var n;n=r,localStorage.setItem(`${o}_${e}`,n),location.reload()}function s(e,t){const r=document.createElement("a");r.id="kt-import-button",r.classList="music_master_btn pointer p_5 t_c f_12 f_b white",r.borderRadius="8px",r.backgroundColor="#F31A7D",r.display="block",r.margin="10px auto",r.padding="5px",r.width="fit-content",r.append(document.createTextNode(e));document.querySelectorAll(".title")[0].insertAdjacentElement("afterend",r),document.querySelector("#kt-import-button").onclick=t}function m(e){let t=document.querySelector("#kt-import-status");if(!t){t=document.createElement("p"),t.id="kt-import-status",t.style="text-align: center; background-color: #fff;";document.querySelectorAll(".title")[0].insertAdjacentElement("afterend",t)}t.innerText=e}async function p(e,t){const r=await fetch(e,{method:"GET",headers:{Authorization:`Bearer ${c()}`}}),n=await r.json();if(n.success){if("ongoing"===n.body.importStatus)return m("Importing scores... "+n.description+" Progress: "+n.body.progress.description),void setTimeout(p,1e3,e,t);if("completed"!==n.body.importStatus)m(n.description);else{console.log(n.body);let e=n.description+` ${n.body.import.scoreIDs.length} scores`;if(t&&(e+=` and Dan ${t}`),n.body.import.errors.length>0){e+=`, ${n.body.import.errors.length} errors (see console log for details)`;for(const e of n.body.import.errors)console.log(`${e.type}: ${e.message}`)}m(e)}}else m("Terminal Error: "+n.description)}async function d(e,t){let n={};t&&(n.dan={1:"DAN_1",2:"DAN_2",3:"DAN_3",4:"DAN_4",5:"DAN_5",6:"DAN_6",7:"DAN_7",8:"DAN_8",9:"DAN_9",10:"DAN_10",11:"SHINSHODAN",12:"SHINDAN_2",13:"SHINDAN_3",14:"SHINDAN_4",15:"SHINDAN_5",16:"SHINDAN_6",17:"SHINDAN_7",18:"SHINDAN_8",19:"SHINDAN_9",20:"SHINDAN_10",21:"SHINKAIDEN"}[t]);const o={meta:{game:"maimaidx",playtype:"Single",service:"site-importer"},scores:e,classes:n};console.log(JSON.stringify(o));const i=fetch(`${r}/ir/direct-manual/import`,{method:"POST",headers:{Authorization:"Bearer "+c(),"Content-Type":"application/json","X-User-Intent":"true"},body:JSON.stringify(o)});document.querySelector("#kt-import-button")?.remove(),m("Submitting scores...");const a=(await(await i).json()).body.url;m("Importing scores..."),p(a,t)}function u([e,t],r){const n={clear:"CLEAR",fc:"FULL COMBO",fcplus:"FULL COMBO+",fcp:"FULL COMBO+",ap:"ALL PERFECT",applus:"ALL PERFECT+",app:"ALL PERFECT+"};let o=null;return o="fc_dummy"===t?n[e]:n[t],null==o&&(o=r>=80?"CLEAR":"FAILED"),o}function f(e){if(e.id)return e.id.includes("sta_")?"standard":"dx";const t=e.querySelector(".music_kind_icon, .playlog_music_kind_icon");return t instanceof HTMLImageElement?t.src.replace("https://maimaidx-eng.com/maimai-mobile/img/music_","").replace(".png",""):"dx"}function _(e,t,r){let n=e.querySelector(t).src.replace("https://maimaidx-eng.com/maimai-mobile/img/diff_","").replace(".png","");return n=n.replace(n[0],n[0].toUpperCase()),"Remaster"===n&&(n="Re:Master"),"dx"===r&&(n="DX "+n),n}async function g(e=document){const t=e.querySelectorAll(".p_10.t_l.f_0.v_b");let r=[];for(let e=0;e<t.length;e++){m(`Fetching recent score ${e+1}/${t.length}...`);const n=t[e];let o={percent:0,lamp:"",matchType:"songTitle",identifier:"",difficulty:"",timeAchieved:0,judgements:{pcrit:0,perfect:0,great:0,good:0,miss:0},hitMeta:{fast:0,slow:0,maxCombo:0}};o.identifier=n.querySelector(".basic_block.m_5.p_5.p_l_10.f_13.break").innerText,"　"===o.identifier&&(o.identifier="");const i=f(n);o.difficulty=_(n,".playlog_diff.v_b",i);const c=n.querySelector(".playlog_achievement_txt.t_r").innerHTML.replace('<span class="f_20">',"").replace("</span>","");o.percent=parseFloat(c.match(/[0-9]+.[0-9]+/)[0]);const a=n.querySelector(".w_80.f_r");let l=null;null!==a&&(l=a.src.replace("https://maimaidx-eng.com/maimai-mobile/img/playlog/","").replace(".png",""));const s=n.querySelector(".playlog_result_innerblock.basic_block.p_5.f_13").children[1].src.replace("https://maimaidx-eng.com/maimai-mobile/img/playlog/","").replace(".png?ver=1.30","");o.lamp=u([l,s],o.percent);const p=n.querySelector(".sub_title.t_c.f_r.f_11").getElementsByClassName("v_b")[1].innerHTML.match("([0-9]{4})/([0-9]{1,2})/([0-9]{1,2}) ([0-9]{1,2}):([0-9]{2})");let[d,g,y,b,S,h]=p;1===y.length&&(y="0"+y),1===b.length&&(b="0"+b),1===S.length&&(S="0"+S);const A=new Date(`${g}-${y}-${b}T${S}:${h}:00.000+09:00`);o.timeAchieved=A.valueOf();const N=n.querySelector(".m_t_5.t_r").getElementsByTagName("input")[0].value;let k=await fetch(`/maimai-mobile/record/playlogDetail/?idx=${N}`),D=(new DOMParser).parseFromString(await k.text(),"text/html");[...D.querySelector(".playlog_notes_detail.t_r.f_l.f_11.f_b").querySelectorAll("tr")].slice(1).map((e=>{o.judgements.pcrit=o.judgements.pcrit+Number(e.querySelectorAll("td")[0].innerHTML),o.judgements.perfect=o.judgements.perfect+Number(e.querySelectorAll("td")[1].innerHTML),o.judgements.great=o.judgements.great+Number(e.querySelectorAll("td")[2].innerHTML),o.judgements.good=o.judgements.good+Number(e.querySelectorAll("td")[3].innerHTML),o.judgements.miss=o.judgements.miss+Number(e.querySelectorAll("td")[4].innerHTML)})),o.hitMeta.fast=Number(D.querySelectorAll(".w_96.f_l.t_r")[0].textContent),o.hitMeta.slow=Number(D.querySelectorAll(".w_96.f_l.t_r")[1].textContent),o.hitMeta.maxCombo=Number(D.querySelector(".f_r.f_14.white").innerHTML.match(/([0-9]+)\/([0-9]+)/)[1]),r.push(o)}d(r)}async function y(){const e=[];for(let t=0;t<5;t++){m(`Fetching scores for ${i[t]}...`);const r=await fetch(`/maimai-mobile/record/musicGenre/search/?genre=99&diff=${t}`);(new DOMParser).parseFromString(await r.text(),"text/html").querySelectorAll(".w_450.m_15.p_r.f_0").forEach((t=>{scoreData={percent:0,lamp:"",matchType:"songTitle",identifier:"",difficulty:_(t,".h_20.f_l",f(t))},scoreData.identifier=t.querySelector(".music_name_block.t_l.f_13.break").innerText,"　"===scoreData.identifier&&(scoreData.identifier="");const r=t.querySelector(".music_score_block.w_120.t_r.f_l.f_12");if(null===r)return;scoreData.percent=parseFloat(r.innerText.match(/[0-9]+.[0-9]+/)[0]);const n=t.querySelectorAll(".h_30.f_r")[1].src.replace("https://maimaidx-eng.com/maimai-mobile/img/music_icon_","").replace(".png?ver=1.30","");scoreData.lamp=u(["",n],scoreData.percent),e.push(scoreData)}))}document.querySelector("#kt-import-pb-warning")?.remove(),d(e)}function b(){const e=document.querySelector(".h_35.f_l").src;let t=Number(e.replace("https://maimaidx-eng.com/maimai-mobile/img/course/course_rank_","").replace(".png","").substring(0,2));t>11&&(t-=1),d([],t)}switch(console.log("running"),location.pathname){case"/maimai-mobile/record/musicGenre/":case"/maimai-mobile/record/musicWord/":case"/maimai-mobile/record/musicLevel/":case"/maimai-mobile/record/musicVersion/":case"/maimai-mobile/record/musicSort/":s("IMPORT ALL PBs",(function(){document.querySelector("#kt-import-button").remove(),s("Confirm DANGEROUS operation",y),document.querySelector("#kt-import-button").insertAdjacentHTML("afterend",'\n\t<p id="kt-import-pb-warning" class="p_10" style="text-align: center; background-color: #fff">\n\t  <span style="color: #f00">WARNING!</span>\n\t  PB import is not recommended in general! PBs do not have timestamp data, and will not create\n\t  sessions. Only import PBs <em>after</em> importing recent scores.\n\t</p>\n  ')}));break;case"/maimai-mobile/record/":s("IMPORT RECENT SCORES",g);break;case"/maimai-mobile/home/":!function(){const e=document.querySelectorAll(".comment_block.break.f_l.f_12")[0],t=!!c(),r=document.createElement("p");t||(r.append(document.createTextNode("You don't have an API key set up. Please set up an API key before proceeding.")),r.append(document.createElement("br")));let n=t?"Reconfigure API key (if broken)":"Set up API key";const o=document.createElement("a");o.id="setup-api-key-onclick",o.append(document.createTextNode(n)),o.onclick=a,r.append(o);const i=document.createElement("div");if(i.append(r),t){const e=document.createElement("a"),t="Import recent scores (preferred)";e.onclick=async()=>{const e=await fetch("/maimai-mobile/record/"),t=(new DOMParser).parseFromString(await e.text(),"text/html");await g(t)},e.append(t),e.append(document.createElement("br")),i.append(e);const r=document.createElement("a"),n="Import all PBs";r.onclick=y,r.append(n),r.append(document.createElement("br")),i.append(r);const o=document.createElement("a"),c="Import dan";o.onclick=b,o.append(c),i.append(o)}e.append(i),e.id="kt-import-status"}();break;case"/maimai-mobile/playerData/":s("IMPORT DANS",b)}
